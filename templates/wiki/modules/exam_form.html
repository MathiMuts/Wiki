{% extends "./wiki_base.html" %}
{% block title%}{% if exam %}{{ exam.title }}{% else %}{{ action }} Exam{% endif %} - Wiki{% endblock %}
{% load static %}
{% block content %}
    <h1>{{ action }} Exam/Sub-Page</h1>
    <p class="page-meta">For Wiki Page: <a href="{{ parent_page.get_absolute_url }}">{{ parent_page.title }}</a></p>
    {% if exam %}<h2 class="page-meta">Editing: {{ exam.title }}</h2>{% endif %}
    
    <form method="post" id="examPageForm" action=""> 
        {% csrf_token %}

        <div class="form-row-responsive">
            <div class="form-group form-group-responsive">
                <label for="{{ form.title.id_for_label }}">Title:</label>
                {{ form.title }}
                {% if form.title.errors %}<div class="form-field-error">{{ form.title.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="form-group form-group-responsive">
                <label for="{{ form.slug.id_for_label }}">Slug (URL Path):</label>
                {{ form.slug }}
                {% if form.slug.help_text %}<small class="form-text text-muted">{{ form.slug.help_text|safe }}</small>{% endif %}
                {% if form.slug.errors %}<div class="form-field-error">{{ form.slug.errors|join:", " }}</div>{% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.page_type.id_for_label }}">Content Type & PDF Method:</label>
            {{ form.page_type }} {# This is your toggle #}
            {% if form.page_type.help_text %}<small class="form-text text-muted">{{ form.page_type.help_text|safe }}</small>{% endif %}
            {% if form.page_type.errors %}<div class="form-field-error">{{ form.page_type.errors|join:", " }}</div>{% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.content.id_for_label }}">Content:</label>
            {{ form.content }}
            {% if form.content.errors %}<div class="form-field-error">{{ form.content.errors|join:", " }}</div>{% endif %}
        </div>
        <p><small>Use the selected format. The PDF will be (re)generated when you save.</small></p>
        
        <div class="actions edit-buttons">
            <div>
                <button type="submit" class="edit"> 
                    {% if action == 'Create' %}Create & Generate PDF{% else %}Save & Regenerate PDF{% endif %}
                </button>
                <a href="{{ parent_page.get_absolute_url }}" class="button-link cancel">Cancel</a>
            </div>
</form> 
        {% if exam and action == 'Edit' %}
            <form action="{% url 'wiki:exam_delete' parent_slug=parent_page.slug exam_slug=exam.slug %}" method="post" style="display: inline; margin: 0;" id="deleteExamForm">
                {% csrf_token %}
                <button type="button" class="delete hold-to-delete-exam-btn" 
                        data-default-text="Delete This Sub-Page" 
                        data-holding-text="Hold to Delete..." 
                        data-ready-text="Release to Delete!">
                    <span class="btn-text">Delete This Sub-Page</span>
                    <span class="progress-fill"></span>
                </button>
            </form>
        {% endif %}
        </div>

    {% if exam and exam.pdf_file %}
        <hr style="margin: 2rem 0;">
        <h4>Current PDF:</h4>
        <p><a href="{{ exam.get_download_url }}" target="_blank">{{ exam.pdf_file.name|cut:"wiki_exams/"|cut:parent_page.slug|cut:"/" }}</a></p>
    {% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Optional: JS for Hold-to-delete button for exams ---
    const deleteExamBtn = document.querySelector('.hold-to-delete-exam-btn');
    const deleteExamForm = document.getElementById('deleteExamForm');
    if (deleteExamBtn && deleteExamForm) {
        // (You can copy and adapt the hold-to-delete JS from wiki_form.html,
        //  adjusting selectors and confirmation message for exams)
        // For brevity, a simple confirm for now:
        deleteExamBtn.addEventListener('click', function(e){
            if (!confirm('Are you sure you want to delete this Exam/Sub-Page? This action cannot be undone.')) {
                e.preventDefault();
            } else {
                deleteExamForm.submit();
            }
        });
    }

    // --- Optional: JS for Textarea Enhancements ---
    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    if (contentTextarea && typeof initializeWikiEditorEnhancements === 'function') {
        initializeWikiEditorEnhancements(contentTextarea, 4); // Apply tab indent, etc.
    }
    // Auto-resize (from wiki_form.html, adapt if needed or simplify)
    if (contentTextarea) {
        let previousValue = contentTextarea.value;
        function getTrailingEmptyLineCount(text) { if (!text) return 0; const lines = text.split('\n'); let count = 0; for (let i = lines.length - 1; i >= 0; i--) { if (lines[i].trim() === "") { count++; } else { break; } } return count; }
        function autoResizeAndManageLines() {
            const DESIRED_MINIMUM_TRAILING_EMPTY_LINES = 1; // Less aggressive for exams
            let valueToProcess = contentTextarea.value;
            const existingTrailing = getTrailingEmptyLineCount(valueToProcess);
            const linesToAdd = DESIRED_MINIMUM_TRAILING_EMPTY_LINES - existingTrailing;
            if (linesToAdd > 0) { for (let i = 0; i < linesToAdd; i++) { valueToProcess += '\n'; } }
            if (contentTextarea.value !== valueToProcess) { contentTextarea.value = valueToProcess; }
            contentTextarea.style.height = 'auto';
            contentTextarea.style.height = (contentTextarea.scrollHeight) + 'px';
            previousValue = contentTextarea.value;
        }
        autoResizeAndManageLines();
        contentTextarea.addEventListener('input', autoResizeAndManageLines);
    }
});
</script>
{% endblock %}