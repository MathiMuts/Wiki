{% load static %}
<link rel="stylesheet" href="{% static 'wiki/css/menu.css'%}">

<img src="{% static 'wiki/icons/wina.svg' %}" class="desktop-only" alt="Wina Logo" style="position: fixed; left: calc(2vw - 2.5rem); top: calc(2vw - 38px); width: 25rem; z-index: 100001; color: var(--primary-text-color);">

<div id="menu" class="card-plain">
    <div class="menu-search-container">
        <form id="wikiMenuSearchForm" action="{% url 'wiki:search' %}" method="GET">
            <input class="input" type="search" id="wikiMenuSearchInput" name="q" placeholder="Search wiki pages..." aria-label="Search wiki pages" autocomplete="off">
        </form>
    </div>
    <ul id="itembar">
        {# Pinned items will be rendered here by Django #}
        {% if custom_wiki_menu_sections %}
            {% for section in custom_wiki_menu_sections %}
                {% if section.items %}
                    <h3 data-section-title>{{ section.title }}</h3> {# Added data-attribute for JS #}
                    {% for item in section.items %}
                        {% if item.login_required %}
                            {% if user.is_authenticated %}
                            <li data-pinned-item data-slug="{{ item.slug|default:'' }}">
                                <a href="{{ item.url }}" class="link" {% if item.is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                                    <button class="button-transparent"><span class="circle"></span>{{ item.text }}</button>
                                </a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li data-pinned-item data-slug="{{ item.slug|default:'' }}">
                                <a href="{{ item.url }}" class="link" {% if item.is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                                    <button class="button-transparent"><span class="circle"></span>{{ item.text }}</button>
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% else %}
            <li data-pinned-item><a href="{% url 'wiki:wiki' %}" class="link"><button class="button-transparent">All Pages</button></a></li>
            {% if user.is_authenticated %}
            <li data-pinned-item><a href="{% url 'wiki:page_create' %}" class="link"><button class="button-transparent">Create Page</button></a></li>
            {% endif %}
            <li data-pinned-item><small style="padding-left: 10px; color: #777;">Menu not configured.</small></li>
            <li data-pinned-item><small style="padding-left: 10px; color: #777;">Create a page with slug '{{ MENU_CONFIG_PAGE_SLUG }}'.</small></li>
        {% endif %}

        {# Container for dynamic search results from all pages #}
        <div id="dynamicSearchResultsContainer" style="display: none;">
            <h3 id="dynamicSearchResultsHeading">All Matching Pages</h3>
            <ul id="dynamicSearchResultsList">
                {# JS will populate this #}
            </ul>
        </div>
    </ul>
</div>

<button id="hamburger" aria-label="Toggle menu" class="button-secondary">
    <span class="line line1"></span>
    <span class="line line2"></span>
    <span class="line line3"></span>
</button>

<script>
const hamburger = document.getElementById('hamburger');
const menu = document.getElementById('menu');
const menuConfigSlug = "{{ MENU_CONFIG_PAGE_SLUG }}";
const allWikiPagesData = JSON.parse('{{ all_wiki_pages_json|escapejs }}');

const desktopBreakpoint = window.matchMedia('(min-width: 1101px)');

function updateHamburgerActiveState() {
    if (menu.classList.contains('open') && !desktopBreakpoint.matches) {
        hamburger.classList.add('is-active');
    } else {
        hamburger.classList.remove('is-active');
    }
}

function handleMenuStateForResize() {
    if (desktopBreakpoint.matches) {
        menu.classList.remove('open');
        document.body.style.overflow = '';
    } else {
        if (menu.classList.contains('open')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
    updateHamburgerActiveState();
}

handleMenuStateForResize();
desktopBreakpoint.addEventListener('change', handleMenuStateForResize);

hamburger.addEventListener('click', function() {
    if (!desktopBreakpoint.matches) {
        menu.classList.toggle('open');
        if (menu.classList.contains('open')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
        updateHamburgerActiveState();
    }
});

const searchInput = document.getElementById('wikiMenuSearchInput');
const itembar = document.getElementById('itembar');
const pinnedMenuItems = itembar.querySelectorAll('li[data-pinned-item]');
const pinnedMenuHeadings = itembar.querySelectorAll('h3[data-section-title]');
const dynamicSearchResultsContainer = document.getElementById('dynamicSearchResultsContainer');
const dynamicSearchResultsList = document.getElementById('dynamicSearchResultsList');

if (searchInput && itembar) {
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const visiblePinnedSlugs = new Set();
        let hasVisiblePinnedItemInSection = false;

        pinnedMenuItems.forEach(item => {
            const itemText = item.textContent.toLowerCase();
            const itemSlug = item.dataset.slug;
            if (itemText.includes(searchTerm)) {
                item.style.display = '';
                if(itemSlug) visiblePinnedSlugs.add(itemSlug);
            } else {
                item.style.display = 'none';
            }
        });

        // Filter pinned section headings
        pinnedMenuHeadings.forEach(heading => {
            let nextElement = heading.nextElementSibling;
            let sectionHasVisibleItem = false;
            while (nextElement && nextElement.tagName === 'LI' && nextElement.hasAttribute('data-pinned-item')) {
                if (nextElement.style.display !== 'none') {
                    sectionHasVisibleItem = true;
                    break;
                }
                nextElement = nextElement.nextElementSibling;
            }
            const headingText = heading.textContent.toLowerCase();
            if (sectionHasVisibleItem || headingText.includes(searchTerm)) {
                heading.style.display = '';
            } else {
                heading.style.display = 'none';
            }
        });

        dynamicSearchResultsList.innerHTML = '';
        let dynamicResultsFound = false;

        if (searchTerm !== '') {
            allWikiPagesData.forEach(page => {
                if (page.title.toLowerCase().includes(searchTerm)) {
                    if (!visiblePinnedSlugs.has(page.slug)) {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = page.url;
                        a.classList.add('link');

                        const button = document.createElement('button');
                        button.classList.add('button-transparent');

                        const circleSpan = document.createElement('span');
                        circleSpan.classList.add('circle');
                        button.appendChild(circleSpan);

                        button.appendChild(document.createTextNode(page.title));
                        a.appendChild(button);
                        li.appendChild(a);
                        dynamicSearchResultsList.appendChild(li);
                        dynamicResultsFound = true;
                    }
                }
            });
        }

        if (dynamicResultsFound) {
            dynamicSearchResultsContainer.style.display = 'block';
        } else {
            dynamicSearchResultsContainer.style.display = 'none';
        }

        if (searchTerm === '') {
            pinnedMenuItems.forEach(item => item.style.display = '');
            pinnedMenuHeadings.forEach(heading => heading.style.display = '');
            dynamicSearchResultsContainer.style.display = 'none';
        }
    });
}
</script>