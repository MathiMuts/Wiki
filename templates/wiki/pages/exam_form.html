{% extends "../modules/_base.html" %}
{% comment %} templates/wiki/pages/exam_form.html {% endcomment %}
 
{% block title%}{% if exam %}{{ exam.title }}{% else %}{{ action }} Exam{% endif %} - Wiki{% endblock %}
{% load static %}
{% block content %}
    <h1>{{ action }} Exam{% if parent_page %} for {{ parent_page.title }}: <strong class="page-meta"> {{ exam.title|default:"" }}</strong>{% endif %}</h1>
    
    <form method="post" id="examPageForm" action=""> 
        {% csrf_token %}

        <div class="form-row-responsive">
            <div class="form-group form-group-responsive">
                <label for="{{ form.title.id_for_label }}">Title:</label>
                {{ form.title }}
                {% if form.title.errors %}<div class="form-field-error">{{ form.title.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="form-group form-group-responsive">
                <label for="{{ form.slug.id_for_label }}">Slug (URL Path):</label>
                {{ form.slug }}
                {% if form.slug.errors %}<div class="form-field-error">{{ form.slug.errors|join:", " }}</div>{% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.page_type.id_for_label }}">Content Type & PDF Method:</label>
            {{ form.page_type }} 
            {% if form.page_type.errors %}<div class="form-field-error">{{ form.page_type.errors|join:", " }}</div>{% endif %}
            <small id="pageTypeHelpText" class="form-text text-muted" style="display:none; color: var(--warning-color); margin-top: 5px;">
                Please select a content type above to enable the editor.
            </small>
        </div>

        <div class="form-group">
            <label for="{{ form.content.id_for_label }}">Content:</label>
            {{ form.content }}
            {% if form.content.errors %}<div class="form-field-error">{{ form.content.errors|join:", " }}</div>{% endif %}
        </div>
        
        <div class="actions edit-buttons">
            <div>
                <button type="submit" class="button-styled button-create"> 
                    {% if action == 'Create' %}Create & Generate PDF{% else %}Save & Regenerate PDF{% endif %}
                </button>
                <a href="{{ parent_page.get_absolute_url }}" class="button-styled button-cancel">Cancel</a>
            </div>
    </form> 
        {% if exam and action == 'Edit' %}
            <form action="{% url 'wiki:exam_delete' parent_slug=parent_page.slug exam_slug=exam.slug %}" method="post" style="display: inline; margin: 0;" id="deleteExamForm">
                {% csrf_token %}
                <button type="button" class="button-styled button-delete hold-to-delete-btn" id="deleteExamBtn"
                        data-default-text="Delete This Exam" 
                        data-holding-text="Hold to Delete..." 
                        data-ready-text="Release to Delete!">
                    <span class="btn-text">Delete This Exam</span>
                    <span class="progress-fill"></span>
                </button>
            </form>
        {% endif %}
        </div>

    {% if exam and exam.pdf_file %}
        <hr style="margin: 2rem 0;">
        <div class="section-card-plain">
            <h4>Current PDF:</h4>
            <p><a class="wikilink" href="{{ exam.get_url }}" target="_blank">{{ exam.pdf_file.name|cut:"wiki_exams/"|cut:parent_page.slug|cut:"/" }}</a></p>
        </div>
    {% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Slugify for Exam Title
        const examTitleInput = document.getElementById('{{ form.title.id_for_label }}');
        const examSlugInput = document.getElementById('{{ form.slug.id_for_label }}');

        if (examTitleInput && examSlugInput) {
            examTitleInput.addEventListener('input', function() {
                if (examSlugInput.value === '' || examSlugInput.dataset.autoGenerated === 'true') {
                    const generatedSlug = slugify_js(this.value); // Use global slugify_js
                    examSlugInput.value = generatedSlug;
                    examSlugInput.dataset.autoGenerated = 'true';
                }
            });
            examSlugInput.addEventListener('input', function() {
                this.dataset.autoGenerated = 'false'; // Manual edit overrides auto-generation
            });
             // Initialize autoGenerated state on page load if slug is empty or matches title slug
            if (examSlugInput.value === '' || examSlugInput.value === slugify_js(examTitleInput.value)) {
                examSlugInput.dataset.autoGenerated = 'true';
            } else {
                examSlugInput.dataset.autoGenerated = 'false';
            }
        }

        // --- Content Type Selector and Textarea Interaction ---
        const pageTypeSelect = document.getElementById('{{ form.page_type.id_for_label }}');
        const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
        const pageTypeHelpText = document.getElementById('pageTypeHelpText'); 

        const latexBoilerplate = `\\documentclass[oneside,a4paper,12pt,explicit]{article}
\\usepackage[accsupp]{axessibility}
\\usepackage[hidelinks]{hyperref}
\\usepackage[english, dutch]{babel}
\\usepackage{amsmath}
\\usepackage{url}
\\title{ Examen {{ parent_page.title|escapejs|default:"this exam" }} }
\\author{ {{ user.username|escapejs|default:"Een Wina Student" }} }
\\date{\\today}

\\begin{document}
\\maketitle

% Write your exam content here. Use LaTeX commands for formatting.
% External files such as images are currently not supported.

\\end{document}`;

        function normalizeWhitespace(str) {
            return str.replace(/\s+/g, ' ').trim();
        }
        const normalizedLatexBoilerplate = normalizeWhitespace(latexBoilerplate);
        let previousPageType = pageTypeSelect ? pageTypeSelect.value : null;

        if (pageTypeSelect && contentTextarea) {
            function handlePageTypeChange() {
                const selectedType = pageTypeSelect.value;
                const currentContent = contentTextarea.value;
                const normalizedCurrentContent = normalizeWhitespace(currentContent);

                if (selectedType === 'latex' || selectedType === 'markdown') {
                    contentTextarea.disabled = false;
                    contentTextarea.placeholder = 'Enter content here. PDF will be generated based on selected type.';
                    if (pageTypeHelpText) pageTypeHelpText.style.display = 'none';

                    // Populate LaTeX boilerplate only on create and if content is empty
                    if (selectedType === 'latex' && currentContent.trim() === '' {% if not exam %} && true {% else %} && false {% endif %}) {
                        contentTextarea.value = latexBoilerplate;
                        // Trigger input event for auto-resize and other listeners
                        contentTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    // Clear LaTeX boilerplate if switching from LaTeX to Markdown and content is still boilerplate
                    else if (previousPageType === 'latex' && selectedType === 'markdown') {
                        if (normalizedCurrentContent === normalizedLatexBoilerplate) {
                            contentTextarea.value = '';
                            contentTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }

                } else { // No type selected or type does not use editor
                    contentTextarea.disabled = true;
                    contentTextarea.placeholder = 'Select a content type above to enable editing.';
                    // contentTextarea.value = ''; // Optionally clear content
                }
                previousPageType = selectedType; // Update for next change
            }

            handlePageTypeChange(); // Initial setup
            pageTypeSelect.addEventListener('change', handlePageTypeChange);

            // Show help text if disabled textarea is clicked
            contentTextarea.addEventListener('click', function() {
                if (this.disabled && pageTypeHelpText) {
                    pageTypeHelpText.style.display = 'block';
                    pageTypeSelect.focus(); // Focus the selector to prompt action
                    setTimeout(() => { 
                         if(pageTypeHelpText) pageTypeHelpText.style.display = 'none';
                    }, 4000);
                }
            });
        }

        // Initialize Auto-Resize for Textarea
        if (contentTextarea) {
            initializeAutoResizeTextarea(contentTextarea, 3); // Use global function
        }
        
        // Initialize Wiki Editor Enhancements
        if (typeof initializeWikiEditorEnhancements === 'function' && contentTextarea) {
            initializeWikiEditorEnhancements(contentTextarea, 4); // Standard tab size
        } else if (contentTextarea) {
            console.warn('initializeWikiEditorEnhancements function not found. Ensure wiki_editor_enhancements.js is loaded.');
        }

        // Initialize Hold-to-Delete Button for Exam
        const deleteExamBtn = document.getElementById('deleteExamBtn');
        const deleteExamForm = document.getElementById('deleteExamForm');
        if (deleteExamBtn && deleteExamForm) {
            const examTitle = "{{ exam.title|escapejs|default:"this exam" }}";
            initializeHoldToDeleteButton(deleteExamBtn, deleteExamForm, examTitle); // Use global function
        }
    });
</script>
{% endblock %}